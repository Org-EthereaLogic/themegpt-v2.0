name: Security & Quality

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  snyk-security:
    name: Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0

      - name: Setup Node
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Snyk security scan
        uses: snyk/actions/node@9adf32b1121593767fc3c057af55b55db032dc04 # master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --sarif-file-output=snyk.sarif --exclude=doc,prompt

      - name: Upload SARIF to GitHub
        uses: github/codeql-action/upload-sarif@bffd034ab1518ad839a542b8a7356e13a240e076 # v3.31.7
        if: ${{ always() && hashFiles('snyk.sarif') != '' }}
        with:
          sarif_file: snyk.sarif

  codacy-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Run Codacy Analysis
        uses: codacy/codacy-analysis-cli-action@30783d03e758713bb5ed7b79292cfb14b9dd9a4a # master
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          api-token: ${{ secrets.CODACY_API_TOKEN }}
          upload: ${{ secrets.CODACY_PROJECT_TOKEN != '' || secrets.CODACY_API_TOKEN != '' }}
          max-allowed-issues: 2147483647

  test-coverage:
    name: Test & Coverage
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0

      - name: Setup Node
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests with coverage
        run: pnpm test:coverage

      - name: Upload coverage to Codacy
        if: ${{ hashFiles('apps/**/coverage/lcov.info') != '' }}
        env:
          CODACY_PROJECT_TOKEN: ${{ secrets.CODACY_PROJECT_TOKEN }}
          CODACY_API_TOKEN: ${{ secrets.CODACY_API_TOKEN }}
          CODACY_ORGANIZATION_PROVIDER: gh
          CODACY_USERNAME: Org-EthereaLogic
          CODACY_PROJECT_NAME: themegpt-v2.0
        run: |
          if [ -z "$CODACY_PROJECT_TOKEN" ] && [ -z "$CODACY_API_TOKEN" ]; then
            echo "No Codacy token configured. Skipping coverage upload."
            exit 0
          fi

          reports=()
          for report in apps/*/coverage/lcov.info; do
            if [ -f "$report" ]; then
              reports+=("-r" "$report")
            fi
          done

          if [ "${#reports[@]}" -eq 0 ]; then
            echo "No coverage reports found to upload."
            exit 1
          fi

          bash <(curl -Ls https://coverage.codacy.com/get.sh) report "${reports[@]}"

  adws-integration:
    name: ADWS Integration
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'adws')
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.12"

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Install ADWS dependencies
        working-directory: adws
        run: uv sync --all-extras

      - name: Validate state files
        run: |
          echo "Checking for forbidden patterns in ADWS code..."
          forbidden=$(grep -rE "TODO|FIXME|NotImplementedError" --include="*.py" adws/ || true)
          if [ -n "$forbidden" ]; then
            echo "::error::Forbidden patterns found in ADWS code:"
            echo "$forbidden"
            exit 1
          fi
          echo "No forbidden patterns found."

      - name: Check complexity budget
        run: |
          echo "Checking file line counts (500-line budget)..."
          violations=0
          for f in $(find adws -name "*.py" -not -path "*/tests/*"); do
            lines=$(wc -l < "$f")
            if [ "$lines" -gt 500 ]; then
              echo "::warning file=$f::$f exceeds 500-line budget ($lines lines)"
              violations=$((violations + 1))
            fi
          done
          if [ "$violations" -gt 0 ]; then
            echo "::warning::$violations file(s) exceed the 500-line complexity budget"
          fi
          echo "Complexity check complete."

      - name: Run ADWS tests
        working-directory: adws
        run: |
          uv run pytest tests/ -v --tb=short \
            --ignore=tests/test_api_connectivity.py \
            -k "not integration" \
            2>&1
